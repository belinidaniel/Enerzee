<!--
  @description       : 
  @author            : Daniel Belini
  @group             : 
  @last modified on  : 09-18-2025
  @last modified by  : Daniel Belini
-->
<apex:page standardController="Opportunity"
           extensions="PDFControllerExtension"
           showQuickActionVfHeader="false">

    <apex:slds />
    <apex:includeScript value="/soap/ajax/30.0/connection.js"/>

    <style>
        /* ===== Uma única rolagem: desabilita scroll externo ===== */
        html, body { height: 100%; overflow: hidden; }
        .page-wrap { display: flex; flex-direction: column; height: 100vh; }

        /* Cabeçalho+form ocupam espaço natural; área do iframe expande */
        .content-area { flex: 1 1 auto; min-height: 0; overflow: hidden; }

        /* Iframe ocupa 100% da área disponível, sem borda; altura é setada via JS */
        #propostaFrame { width: 100%; height: 100%; border: none; display: none; }

        /* Footer no estilo padrão de modal do SLDS, fixo no rodapé do conteúdo */
        .custom-footer{
            position: sticky;
            bottom: 0;
            background: #fff;
            border-top: 1px solid #e5e5e5;
            z-index: 2;
            justify-items: center;
        }

        /* Spinner overlay cobrindo a tela toda */
        .slds-spinner_container{
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.6);
            z-index: 9999;
            display: none;
        }
    </style>

    <apex:form id="mainForm">
        <div class="page-wrap">

            <!-- Spinner global -->
            <div id="spinner" class="slds-spinner_container">
                <div class="slds-spinner slds-spinner_medium slds-spinner_brand" role="status">
                    <span class="slds-assistive-text">Carregando...</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                </div>
            </div>

            <!-- Cabeçalho + seletor -->
            <div class="slds-p-around_medium">
                <h2 class="slds-text-heading_medium slds-m-bottom_small" style="text-align: center;">Gerar Proposta</h2>

                <!-- Mensagens VF (para exibir erros de Apex) -->
                <apex:pageMessages id="msgs"/>

                <div class="slds-form-element slds-m-top_small">
                    <label class="slds-form-element__label">Selecione o modelo de proposta:</label>
                    <div class="slds-form-element__control">
                        <div class="slds-select_container">
                            <apex:selectList value="{!selectedCoverId}" size="1"
                                             onchange="onModeloChange(this.value)"
                                             styleClass="slds-select" id="modeloSelect">
                                <apex:selectOptions value="{!activeCovers}"/>
                            </apex:selectList>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de preview: sem scroll; iframe vai ocupar tudo e terá o único scroll -->
            <div class="content-area slds-p-horizontal_medium slds-m-bottom_xx-large">
                <iframe id="propostaFrame"></iframe>
            </div>

            <!-- Painel oculto com flags do Apex para oncomplete -->
            <apex:outputPanel id="hiddenFlags" style="display:none">
                <apex:inputHidden id="saveOk"  value="{!lastSaveSuccess}"/>
                <apex:inputHidden id="saveMsg" value="{!lastSaveMessage}"/>
            </apex:outputPanel>

            <!-- Footer padrão -->
            <div class="custom-footer slds-p-around_small">
                <div class="slds-grid slds-grid_align-end slds-gutters_large">
                    <div>
                        <apex:commandButton value="Enviar Proposta"
                                            id="btnSalvar"
                                            rerender="msgs,hiddenFlags"
                                            oncomplete="afterSave()"
                                            onclick="mostrarSpinner()"
                                            styleClass="slds-button slds-button_brand"
                                            disabled="disabled"/>
                    </div>
                </div>
            </div>

        </div>
    </apex:form>

    <script>
        // ===== Spinner =====
        function mostrarSpinner(){ document.getElementById('spinner').style.display='block'; }
        function ocultarSpinner(){ document.getElementById('spinner').style.display='none'; }

        // ===== Controla habilitação do botão Salvar =====
        function setSalvarDisabled(disabled){
            var btn = document.getElementById('{!$Component.mainForm.btnSalvar}');
            if(!btn) return;
            btn.disabled = disabled;
            if(disabled){
                btn.classList.remove('slds-button_brand');
                btn.classList.add('slds-button_outline-brand');
            } else {
                btn.classList.add('slds-button_brand');
                btn.classList.remove('slds-button_outline-brand');
            }
        }

        // ===== Ajusta altura do iframe para ocupar o espaço útil entre topo e footer
        function fitIframe(){
            var iframe = document.getElementById('propostaFrame');
            var footer = document.querySelector('.custom-footer');
            if(!iframe) return;
            // posição do topo do iframe na viewport
            var rectTop = iframe.getBoundingClientRect().top;
            var footerH = footer ? footer.offsetHeight : 0;
            var padding = 16; // respiro
            var h = window.innerHeight - rectTop - footerH - padding;
            if (h > 200) iframe.style.height = h + 'px';
        }
        document.addEventListener('DOMContentLoaded', function(){
            setSalvarDisabled(true);
            fitIframe();
        });
        window.addEventListener('resize', fitIframe);

        // ===== Seleção de modelo =====
        function onModeloChange(val){
            if(!val){
                setSalvarDisabled(true);
                var iframe = document.getElementById('propostaFrame');
                iframe.style.display = 'none';
                iframe.src = 'about:blank';
                return;
            }
            abrirPagina(val);
        }

        // ===== Carrega o template no iframe e habilita salvar quando pronto =====
        function abrirPagina(selectedValue){
            if (!selectedValue) return;

            var iframe = document.getElementById('propostaFrame');
            iframe.style.display = 'none';
            mostrarSpinner();

            iframe.onload = function(){
                ocultarSpinner();
                iframe.style.display = 'block';
                setSalvarDisabled(false);
                fitIframe(); // garante altura correta após o carregamento
            };

            var recordId = "{!Opportunity.Id}";
            var template = "{!Opportunity.Parceiro__r.CapaProposta__r.Template__c}";
            var src = "/apex/" + template + "?id=" + recordId + "&selectedCoverId=" + selectedValue + "&isManual=true";
            iframe.src = src;
        }

        // ===== Pós-salvar: toast e fechar somente se sucesso =====
        function afterSave(){
            ocultarSpinner();
            sforce.one.showToast({
                title: 'Sucesso',
                message: 'Proposta Enviada para o Aplicativo.',
                type: 'success',
                mode: 'dismissible' // Usar dismissible para ambos para não travar o usuário
            });
            sforce.one.closeDialog();
        }

        // ===== Fechar ação (Cancelar) =====
        function fecharAcao(){
            if (typeof sforce !== 'undefined' && sforce.one && sforce.one.closeDialog) {
                sforce.one.closeDialog();
            } else if (typeof closeQuickAction === 'function') {
                closeQuickAction();
            } else {
                window.close();
            }
        }
    </script>

</apex:page>
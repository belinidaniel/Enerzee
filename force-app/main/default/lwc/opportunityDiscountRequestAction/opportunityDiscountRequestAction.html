<template>
    <div class="discount-action">
        <template if:true={isLoading}>
            <div class="spinner-wrapper">
                <lightning-spinner size="medium" alternative-text="Carregando"></lightning-spinner>
            </div>
        </template>

        <template if:false={isLoading}>
            <div class="slds-p-around_medium">
                <template if:true={isStageBlocked}>
                    <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_warning" role="alert">
                        <span class="slds-assistive-text">Aviso</span>
                        <h2>
                            Esta ação está disponível apenas na etapa
                            <strong>{allowedStagesLabel}</strong>.
                        </h2>
                    </div>
                </template>

                <div class="slds-box slds-theme_default slds-m-top_small context-box">
                    <p><strong>Etapa atual:</strong> {stageNameLabel}</p>
                    <p><strong>Valor original da proposta:</strong> {formattedOriginalValue}</p>
                    <p><strong>Última proposta gerada:</strong> {proposalStatusLabel}</p>
                    <template if:false={hasLatestProposal}>
                        <p class="slds-m-top_x-small slds-text-color_error">
                            Não há proposta gerada com URL para esta oportunidade. Gere/envie a proposta antes de solicitar desconto.
                        </p>
                    </template>
                </div>

                <div class="slds-grid slds-wrap slds-gutters slds-m-top_medium">
                    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                        <lightning-input
                            type="number"
                            label="Desconto em valor (R$)"
                            data-field="discountValue"
                            value={discountValue}
                            step="0.01"
                            min="0"
                            onchange={handleInputChange}
                            disabled={isSubmitting}
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
                        <lightning-input
                            type="number"
                            label="Desconto em porcentagem (%)"
                            data-field="discountPercent"
                            value={discountPercent}
                            step="0.01"
                            min="0"
                            onchange={handleInputChange}
                            disabled={isSubmitting}
                        ></lightning-input>
                    </div>
                </div>

                <div class="slds-m-top_small">
                    <p><strong>Desconto calculado para envio (R$):</strong> {formattedRequestDiscountPreview}</p>
                </div>

                <div class="slds-m-top_medium">
                    <lightning-textarea
                        label="Observação"
                        data-field="comments"
                        value={comments}
                        onchange={handleInputChange}
                        disabled={isSubmitting}
                    ></lightning-textarea>
                </div>

                <div class="slds-m-top_large slds-grid slds-grid_align-end slds-gutters_small">
                    <lightning-button
                        label="Cancelar"
                        onclick={handleCancel}
                        disabled={isSubmitting}
                    ></lightning-button>
                    <lightning-button
                        variant="brand"
                        label={submitLabel}
                        onclick={handleSubmit}
                        disabled={isSubmitDisabled}
                    ></lightning-button>
                </div>
            </div>
        </template>
    </div>
</template>

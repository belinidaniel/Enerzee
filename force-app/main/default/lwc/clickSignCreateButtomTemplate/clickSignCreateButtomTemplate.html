<template>
    <lightning-spinner if:true={isLoading} alternative-text="Loading"></lightning-spinner>

    <div if:false={isLoading} class="slds-p-around_medium">
        <!-- Detalhes do Template -->
        <lightning-card title={labels.templateDetails} icon-name="standard:template">
            <div class="slds-p-around_medium">
                <template if:true={template}>
                    <div class="slds-grid slds-wrap slds-gutters">
                        <div class="slds-col slds-size_1-of-2">
                            <p><strong>Nome:</strong> {template.Name}</p>
                            <p><strong>Descrição:</strong> {template.Description__c}</p>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <p><strong>Objeto:</strong> {template.SourceObject__c}</p>
                        </div>
                    </div>
                </template>
            </div>
        </lightning-card>

        <!-- Label do Botão -->
        <lightning-card title="Configuração do Botão" icon-name="standard:custom_object" class="slds-m-top_medium">
            <div class="slds-p-around_medium">
                <lightning-input 
                    type="text" 
                    label={labels.buttonLabel}
                    value={buttonLabel} 
                    onchange={handleButtonLabelChange}
                    placeholder="Ex: Assinar Documento">
                </lightning-input>
            </div>
        </lightning-card>

        <!-- Filtros de Visibilidade (Novo Padrão Salesforce) -->
        <lightning-card title="Filtros de Visibilidade" icon-name="standard:filter" class="slds-m-top_medium">
            <div class="slds-p-around_medium">
                <!-- Operador Lógico Global -->
                <div class="slds-m-bottom_medium">
                    <label class="slds-form-element__label">Condição de Lógica</label>
                    <lightning-radio-group 
                        name="logicOperator" 
                        options={logicOptions}
                        value={logicOperator} 
                        onchange={handleLogicOperatorChange}
                        type="button">
                    </lightning-radio-group>
                </div>

                <!-- Formula (se selecionado) -->
                <template if:true={isFormulaMode}>
                    <lightning-textarea 
                        label="Fórmula"
                        value={formulaExpression}
                        onchange={handleFormulaChange}
                        placeholder="Ex: (Status__c = 'Ativo' AND Tipo__c = 'Premium')"
                        class="slds-m-bottom_medium">
                    </lightning-textarea>
                </template>

                <!-- Filtros por Linha -->
                <template if:false={isFormulaMode}>
                    <div class="slds-box slds-theme_shade slds-p-around_small slds-m-bottom_medium">
                        <template for:each={visibilityFilters} for:item={filter}>
                            <div key={filter.id} class="slds-grid slds-wrap slds-gutters slds-m-bottom_small">
                                <!-- Campo -->
                                <div class="slds-col slds-size_3-of-12">
                                    <lightning-combobox 
                                        data-id={filter.id}
                                        label="Campo"
                                        options={picklistFieldOptions}
                                        value={filter.field}
                                        onchange={handleFilterFieldChange}
                                        placeholder="Selecionar campo">
                                    </lightning-combobox>
                                </div>

                                <!-- Operador -->
                                <div class="slds-col slds-size_3-of-12">
                                    <lightning-combobox 
                                        data-id={filter.id}
                                        label="Operador"
                                        options={operatorOptions}
                                        value={filter.operator}
                                        onchange={handleFilterOperatorChange}
                                        placeholder="Selecionar operador">
                                    </lightning-combobox>
                                </div>

                                <!-- Valor -->
                                <div class="slds-col slds-size_4-of-12">
                                    <template if:true={filter.fieldValueOptions.length}>
                                        <lightning-combobox 
                                            data-id={filter.id}
                                            label="Valor"
                                            options={filter.fieldValueOptions}
                                            value={filter.value}
                                            onchange={handleFilterValueChange}
                                            placeholder="Selecionar valor">
                                        </lightning-combobox>
                                    </template>
                                    <template if:false={filter.fieldValueOptions.length}>
                                        <lightning-input 
                                            data-id={filter.id}
                                            type="text"
                                            label="Valor"
                                            value={filter.value}
                                            onchange={handleFilterValueChange}
                                            placeholder="Digite o valor">
                                        </lightning-input>
                                    </template>
                                </div>

                                <!-- Remover -->
                                <div class="slds-col slds-size_2-of-12 slds-align-middle">
                                    <lightning-button-icon 
                                        data-id={filter.id}
                                        icon-name="utility:delete"
                                        alternative-text="Remover"
                                        onclick={handleRemoveFilter}
                                        variant="bare"
                                        class="slds-m-top_small">
                                    </lightning-button-icon>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Botão Adicionar Filtro -->
                    <lightning-button 
                        label="+ Adicionar Filtro"
                        onclick={handleAddFilter}
                        variant="neutral"
                        icon-name="utility:add"
                        class="slds-m-bottom_medium">
                    </lightning-button>
                </template>
            </div>
        </lightning-card>

        <!-- Mapeamento de Objetos -->
        <template if:true={objectMappings.length}>
            <lightning-card title={labels.fields} icon-name="standard:field" class="slds-m-top_medium">
                <div class="slds-p-around_medium">
                    <table class="slds-table slds-table_bordered">
                        <thead>
                            <tr>
                                <th>{labels.tag}</th>
                                <th>{labels.tagValue}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template for:each={objectMappings} for:item={mapping}>
                                <tr key={mapping.id}>
                                    <td>{mapping.tagLabel}</td>
                                    <td>{mapping.tagValue}</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </lightning-card>
        </template>

        <!-- Botão Criar -->
        <div class="slds-m-top_medium">
            <lightning-button 
                label={labels.createButtonInLayout}
                onclick={createButton}
                variant="brand"
                icon-name="utility:add">
            </lightning-button>
        </div>

        <template if:true={successMessage}>
            <div class="slds-p-around_small slds-m-top_medium slds-box slds-theme_success">
                {successMessage}
            </div>
        </template>
    </div>
</template>

<script>
    export function getLogicOptions() {
        return [
            { label: 'E (todos os critérios)', value: 'E' },
            { label: 'OU (qualquer critério)', value: 'OU' },
            { label: 'Fórmula personalizada', value: 'Formula' }
        ];
    }
</script>

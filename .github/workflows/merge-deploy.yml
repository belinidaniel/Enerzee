name: PRD Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€ Setup Node + SF CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SF CLI
        run: npm install --global @salesforce/cli@latest

      - name: Install sfdx-git-delta
        run: echo y | sf plugins install sfdx-git-delta

      # â”€â”€â”€ Authenticate to Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Secret: SFDX_AUTH_URL_PRD
      # Como gerar: sf org display --verbose --target-org enerzee-PRD | grep "Sfdx Auth Url"
      - name: Authenticate Production
        run: |
          echo "${{ secrets.SFDX_AUTH_URL_PRD }}" > /tmp/auth_url.txt
          sf org login sfdx-url --sfdx-url-file /tmp/auth_url.txt --alias enerzee-PRD --set-default
          rm /tmp/auth_url.txt

      # â”€â”€â”€ Identify changed files in this merge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get changed files
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1..HEAD | grep -E 'force-app/' || true)
          echo "Changed files in this merge:"
          echo "$CHANGED"

          APEX=$(echo "$CHANGED" | grep '\.cls$' | grep -v 'Test\.cls$' | sed 's|force-app/main/default/classes/||' | sed 's|\.cls||' || true)
          TESTS=$(echo "$CHANGED" | grep 'Test\.cls$' | sed 's|force-app/main/default/classes/||' | sed 's|\.cls||' || true)

          for cls in $APEX; do
            test_file="force-app/main/default/classes/${cls}Test.cls"
            if [ -f "$test_file" ]; then
              TESTS="$TESTS ${cls}Test"
            fi
          done

          TESTS=$(echo "$TESTS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "apex_classes=$APEX" >> $GITHUB_OUTPUT
          echo "test_classes=$TESTS" >> $GITHUB_OUTPUT
          echo "has_changes=$([ -n "$CHANGED" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      # â”€â”€â”€ Skip if no metadata changed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Skip if no metadata changes
        if: steps.changed.outputs.has_changes == 'false'
        run: echo "No Salesforce metadata changed. Skipping deploy."

      # â”€â”€â”€ Generate delta package â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate delta package
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          echo "Delta from: HEAD~1 â†’ HEAD (${{ github.sha }})"
          sf sgd source delta \
            --from HEAD~1 \
            --to HEAD \
            --source force-app \
            --output .
          echo "--- package.xml ---"
          cat package/package.xml
          echo "--- destructiveChanges.xml ---"
          cat destructiveChanges/destructiveChanges.xml

      # â”€â”€â”€ Deploy to Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy to Production
        if: steps.changed.outputs.has_changes == 'true'
        id: deploy
        run: |
          TEST_LEVEL="RunLocalTests"
          TEST_ARGS=""

          if [ -n "${{ steps.changed.outputs.test_classes }}" ]; then
            TEST_LEVEL="RunSpecifiedTests"
            TEST_ARGS="--tests ${{ steps.changed.outputs.test_classes }}"
          fi

          DESTRUCTIVE_ARG=""
          if grep -q '<types>' ./destructiveChanges/destructiveChanges.xml 2>/dev/null; then
            DESTRUCTIVE_ARG="--post-destructive-changes destructiveChanges/destructiveChanges.xml"
          fi

          echo "Test level: $TEST_LEVEL"
          echo "Tests: ${{ steps.changed.outputs.test_classes }}"

          sf project deploy start \
            --manifest package/package.xml \
            --target-org enerzee-PRD \
            --test-level $TEST_LEVEL \
            $TEST_ARGS \
            $DESTRUCTIVE_ARG \
            --json > /tmp/deploy_result.json 2>&1

          cat /tmp/deploy_result.json

          STATUS=$(cat /tmp/deploy_result.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('status', 1))")
          exit $STATUS

      # â”€â”€â”€ Report result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Report deploy result
        if: always() && steps.changed.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const deploySuccess = '${{ steps.deploy.outcome }}' === 'success';

            let details = '';
            let testSummary = '';
            try {
              const raw = fs.readFileSync('/tmp/deploy_result.json', 'utf8');
              const json = JSON.parse(raw);
              const result = json?.result;

              if (result?.details?.componentFailures?.length > 0) {
                const failures = result.details.componentFailures.map(e =>
                  `| \`${e.fileName}\` | ${e.lineNumber || '-'} | ${e.problem} |`
                ).join('\n');
                details = `\n\n### âŒ Component Failures\n| File | Line | Error |\n|---|---|---|\n${failures}`;
              }

              if (result?.details?.runTestResult) {
                const tests = result.details.runTestResult;
                const coverage = tests.codeCoverage?.map(c => {
                  const pct = Math.round(((c.numLocations - c.numLocationsNotCovered) / c.numLocations) * 100);
                  return `| ${c.name} | ${c.numLocations - c.numLocationsNotCovered}/${c.numLocations} | ${pct}% |`;
                }).join('\n') || '';
                testSummary = `\n\n### ğŸ§ª Test Results\n` +
                  `- Passed: ${tests.numTestsRun - (tests.failures?.length || 0)}\n` +
                  `- Failed: ${tests.failures?.length || 0}\n` +
                  (tests.failures?.length > 0 ? `\n**Failures:**\n${tests.failures.map(f => `- \`${f.name}.${f.methodName}\`: ${f.message}`).join('\n')}` : '') +
                  (coverage ? `\n\n**Coverage:**\n| Class | Lines | % |\n|---|---|---|\n${coverage}` : '');
              }
            } catch (e) {
              details = '\n\nâš ï¸ NÃ£o foi possÃ­vel ler resultado detalhado do deploy.';
            }

            const status = deploySuccess ? 'âœ…' : 'âŒ';
            const summary = deploySuccess
              ? '**Deploy concluÃ­do com sucesso**'
              : '**Deploy falhou â€” rollback automÃ¡tico pelo Salesforce**';

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: deploySuccess ? 'success' : 'failure',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: deploySuccess ? 'Deploy to PRD succeeded' : 'Deploy to PRD failed',
              context: 'PRD Deploy'
            });

            console.log(`## PRD Deploy Report ${status}\n**Org:** Production (enerzee-PRD)\n**Apex:** ${{ steps.changed.outputs.apex_classes || 'none' }}\n${summary}${details}${testSummary}`);

      - name: Fail job if deploy failed
        if: steps.deploy.outcome == 'failure'
        run: exit 1

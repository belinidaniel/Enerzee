name: UAT PR Validation

on:
  pull_request:
    branches:
      - UAT
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate against UAT
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history needed for git diff

      # â”€â”€â”€ Setup Node + SF CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SF CLI
        run: npm install --global @salesforce/cli@latest

      # â”€â”€â”€ Authenticate to UAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Secret: SFDX_AUTH_URL_UAT
      # Como gerar: sf org display --verbose --target-org enerzee-UAT | grep "Sfdx Auth Url"
      - name: Authenticate UAT
        run: |
          echo "${{ secrets.SFDX_AUTH_URL_UAT }}" > /tmp/auth_url.txt
          sf org login sfdx-url --sfdx-url-file /tmp/auth_url.txt --alias enerzee-UAT --set-default
          rm /tmp/auth_url.txt

      # â”€â”€â”€ Identify changed files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get changed files
        id: changed
        run: |
          CHANGED=$(git diff --name-only origin/UAT...HEAD | grep -E '\.(cls|trigger|lwc|flow-meta\.xml|object-meta\.xml|field-meta\.xml|permissionset-meta\.xml|flexipage-meta\.xml|labels-meta\.xml)' || true)
          echo "Changed metadata files:"
          echo "$CHANGED"

          APEX=$(git diff --name-only origin/UAT...HEAD | grep '\.cls$' | grep -v 'Test\.cls$' | sed 's|force-app/main/default/classes/||' | sed 's|\.cls||' || true)
          TESTS=$(git diff --name-only origin/UAT...HEAD | grep 'Test\.cls$' | sed 's|force-app/main/default/classes/||' | sed 's|\.cls||' || true)

          for cls in $APEX; do
            test_file="force-app/main/default/classes/${cls}Test.cls"
            if [ -f "$test_file" ]; then
              TESTS="$TESTS ${cls}Test"
            fi
          done

          TESTS=$(echo "$TESTS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "apex_classes=$APEX" >> $GITHUB_OUTPUT
          echo "test_classes=$TESTS" >> $GITHUB_OUTPUT
          echo "has_changes=$([ -n "$CHANGED" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      # â”€â”€â”€ Static Analysis (PMD via Salesforce Code Analyzer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Code Analyzer
        if: steps.changed.outputs.has_changes == 'true'
        id: analysis
        continue-on-error: true
        run: |
          sf plugins install @salesforce/sfdx-scanner

          CHANGED_APEX=$(git diff --name-only origin/UAT...HEAD | grep '\.cls$' | tr '\n' ',' | sed 's/,$//')

          if [ -n "$CHANGED_APEX" ]; then
            sf scanner run \
              --target "$CHANGED_APEX" \
              --format table \
              --severity-threshold 2 \
              --engine pmd \
              2>&1 | tee /tmp/analysis_result.txt || true
          else
            echo "No Apex files changed." | tee /tmp/analysis_result.txt
          fi

      # â”€â”€â”€ Dry-run Deploy (Validation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Dry-run Deploy Validation
        if: steps.changed.outputs.has_changes == 'true'
        id: deploy
        run: |
          TEST_LEVEL="RunLocalTests"
          TEST_ARGS=""

          if [ -n "${{ steps.changed.outputs.test_classes }}" ]; then
            TEST_LEVEL="RunSpecifiedTests"
            TEST_ARGS="--tests ${{ steps.changed.outputs.test_classes }}"
          fi

          sf project deploy start \
            --source-dir force-app \
            --target-org enerzee-UAT \
            --dry-run \
            --test-level $TEST_LEVEL \
            $TEST_ARGS \
            --json > /tmp/deploy_result.json 2>&1 || true

          cat /tmp/deploy_result.json

      # â”€â”€â”€ Parse & Comment on PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment validation result on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let deployResult = 'âš ï¸ Deploy result not available';
            let deployStatus = 'âš ï¸';
            try {
              const raw = fs.readFileSync('/tmp/deploy_result.json', 'utf8');
              const json = JSON.parse(raw);
              if (json.status === 0) {
                deployStatus = 'âœ…';
                deployResult = 'âœ… **Dry-run passed** â€” sem erros de compilaÃ§Ã£o ou testes';
              } else {
                deployStatus = 'âŒ';
                const errors = json?.result?.details?.componentFailures?.map(e =>
                  `- \`${e.fileName}\` linha ${e.lineNumber}: ${e.problem}`
                ).join('\n') || json.message || 'Erro desconhecido';
                deployResult = `âŒ **Dry-run falhou**\n${errors}`;
              }
            } catch (e) {
              deployResult = 'âš ï¸ NÃ£o foi possÃ­vel ler resultado do deploy';
            }

            let analysisResult = '';
            try {
              const analysis = fs.readFileSync('/tmp/analysis_result.txt', 'utf8');
              analysisResult = analysis.trim() ? `\n\n### ğŸ” Code Analyzer\n\`\`\`\n${analysis.substring(0, 3000)}\n\`\`\`` : '\n\n### ğŸ” Code Analyzer\nâœ… Sem problemas encontrados';
            } catch (e) {}

            const changedApex = `${{ steps.changed.outputs.apex_classes }}`;
            const testClasses = `${{ steps.changed.outputs.test_classes }}`;

            const body = `## UAT PR Validation Report ${deployStatus}

            **Branch:** \`${{ github.head_ref }}\` â†’ \`UAT\`
            **Org:** UAT (enerzee-UAT)

            ### ğŸ“¦ Escopo
            **Apex alterado:** ${changedApex || '_nenhum_'}
            **Testes mapeados:** ${testClasses || '_nenhum â€” RunLocalTests usado_'}

            ### ğŸš€ Dry-run Deploy
            ${deployResult}${analysisResult}

            ---
            _Gerado automaticamente por [UAT PR Validation workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
